<link rel="import" href="./bower_components/polymer/polymer.html">
<link rel="import" href="./bower_components/paper-button/paper-button.html">
<link rel="import" href="post-service.html">
<link rel="import" href="post-card.html">


<polymer-element name="post-list" attributes="show userid" >
  <template>
    <style>
    :host {
      display: inline-block;
      width: 100%;
      margin-left: 30px;
    }
    post-card {
      margin: 5px;
      width: 221px;
      height: 120px;
    }
    #totals {
      text-align:right;
    }
    </style>

    <post-service id="service" posts="{{posts}}" on-ajax-data-received="{{handleServerData}}"></post-service>
    <paper-toast id="toast" text="Sold"></paper-toast>

    <div horizontal layout center wrap>
      <paper-action-dialog id="confirmSale" backdrop autoCloseDisabled>
        <h3>Current Transaction:</h3>
        <p id="productInfo"></p>
        <p id="totals"></p>

        <paper-button raised affirmative style="background:#4285f4;color:white;" on-tap="{{confirmTransaction}}">Confirm Sale</paper-button>
        <paper-button raised affirmative on-tap="{{addAnotherProduct}}">Add More Product</paper-button>
        <paper-button raised dismissive on-tap="{{refreshPage}}">Cancel Transaction</paper-button>
      </paper-action-dialog>
      <!-- <post-card id="newCard"
        favorite="true"
        hidden?="false">
        <paper-fab icon="create" class="blue" title="create" on-tap="{{handleNewCard}}"></paper-fab>
        <h2></h2>
        <p>Add A new Product</p>
      </post-card> -->
      <template repeat="{{post in posts}}">
        <post-card
          on-card-tap="{{handleCard}}"
          hidden?="{{show != post.brand && show != 'all'}}">
          <img src="images/{{post.picture}}" width="70" height="70">
          <h2>${{post.price}}</h2>
          <h4>{{post.stock}}</h4>
          <h6>{{post.name}}</h6>
        </post-card>
      </template>

    </div>
  </template>

  <script>
  Polymer({
    created: function() {
      this.count = 0;
      this.totalPrice = 0.0;
      this.transactionPosts = [];
    },
    handleCard: function(event, detail, sender) {
      var post = sender.templateInstance.model.post;
      if (post.stock == 0) {
        this.$.toast.text="This item is out of stock.";
        this.$.toast.show();
      } else {
        this.transactionPosts.push(post);
        post.stock -= 1;
        this.count += 1;
        this.totalPrice += post.price;
        // this.$.service.removeInventoryItem(post.id);
        //console.log(this.userid);
        this.$.productInfo.innerHTML += "$" + post.price + " " + post.name + "<br>";
        this.$.totals.innerHTML = "<hr>$" + this.totalPrice + " for " + this.count + " items <br>";
        this.$.confirmSale.toggle();
      }
    },
    handleNewCard: function(event, detail, sender) {
      this.$.service.insertInventoryItem();
    },
    handleServerData: function(event, detail, sender) {
      this.$.toast.show();
    },
    refreshPage: function(event, detail, sender) {
      window.location.reload();
    },
    addAnotherProduct: function(event, detail, sender) {
      this.$.toast.text="Choose another product to add";
      this.$.toast.show();
    },
    confirmTransaction: function(event, detail, sender) {
      for (var i = 0; i < this.transactionPosts.length; i++) {
        console.log("updating: ", this.transactionPosts[i]);
        this.$.service.updateInventoryItem(this.transactionPosts[i]);
      }

      this.$.service.saveTransaction(this.userid, this.count, this.totalPrice);

      this.$.toast.text="Transaction complete";
      this.$.toast.show();
      setTimeout(function() {
        window.location.reload();
      }, 1500);
    }
  });
  </script>
</polymer-element>
